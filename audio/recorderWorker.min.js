function init(e){sampleRate=e.sampleRate,outputRate=Math.min(e.outputRate,sampleRate)}function record(e){recBuffersL.push(e[0]),recBuffersR.push(e[1]),recLength+=e[0].length}function exportWAV(e,t){this.postMessage({type:"exportWAV",data:_exportWAV(e),param:t})}function exportWAVBase64(e){var t=_exportWAV(e),r=new FileReader,a=this;r.onload=function(e){a.postMessage({data:e.target.result,size:t.size})},r.readAsDataURL(t)}function _exportWAV(e){var t=mergeBuffers(recBuffersL,recLength),r=(mergeBuffers(recBuffersR,recLength),encodeWAV(t,!0)),a=new Blob([r],{type:e});return a}function exportMonoWAV(e){var t=mergeBuffers(recBuffersL,recLength),r=encodeWAV(t,!0),a=new Blob([r],{type:e});this.postMessage({type:"exportMonoWAV",data:a})}function getBuffers(){var e=mergeBuffers(recBuffersL,recLength),t=mergeBuffers(recBuffersR,recLength),r=[e,t];this.postMessage({type:"getBuffers",data:r})}function clear(){recLength=0,recBuffersL=[],recBuffersR=[]}function mergeBuffers(e,t){for(var r=new Float32Array(t),a=0,n=0;n<e.length;n++)r.set(e[n],a),a+=e[n].length;return r}function interleave(e,t){for(var r=e.length+t.length,a=new Float32Array(r),n=0,s=0;n<r;)a[n++]=e[s],a[n++]=t[s],s++;return a}function floatTo16BitPCM(e,t,r){for(var a=0;a<r.length;a++,t+=2){var n=Math.max(-1,Math.min(1,r[a]));e.setInt16(t,n<0?32768*n:32767*n,!0)}}function writeString(e,t,r){for(var a=0;a<r.length;a++)e.setUint8(t+a,r.charCodeAt(a))}function compress(e){if(sampleRate!=outputRate){for(var t=sampleRate/outputRate,r=Math.ceil(e.length/t),a=new Float32Array(r),n=0,s=0;n<r;s+=t)a[n++]=e[~~s];return a}return e}function encodeWAV(e,t){e=compress(e);var r=new ArrayBuffer(44+2*e.length),a=new DataView(r);return writeString(a,0,"RIFF"),a.setUint32(4,32+2*e.length,!0),writeString(a,8,"WAVE"),writeString(a,12,"fmt "),a.setUint32(16,16,!0),a.setUint16(20,1,!0),a.setUint16(22,t?1:2,!0),a.setUint32(24,outputRate,!0),a.setUint32(28,4*outputRate,!0),a.setUint16(32,4,!0),a.setUint16(34,16,!0),writeString(a,36,"data"),a.setUint32(40,2*e.length,!0),floatTo16BitPCM(a,44,e),a}var recLength=0,recBuffersL=[],recBuffersR=[],sampleRate,outputRate;this.onmessage=function(e){switch(e.data.command){case"init":init(e.data.config);break;case"record":record(e.data.buffer);break;case"exportWAV":exportWAV(e.data.type,e.data.param);break;case"exportWAVBase64":exportWAVBase64(e.data.type);break;case"exportMonoWAV":exportMonoWAV(e.data.type);break;case"getBuffers":getBuffers();break;case"clear":clear()}};