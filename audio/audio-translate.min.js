!function(t,e){function o(){this.support=!!(c&&navigator.getUserMedia&&window.Worker)}function i(t){this.url=t.url,this.uploadUrl=t.uploadUrl}function r(){}function n(){}function a(){var t=navigator.userAgent.toLowerCase(),e=t.match(/MicroMessenger/i);return e&&e.length>0}function s(){var t=navigator.userAgent.toLowerCase(),e=t.match(/apicloud/i);return e&&e.length>0}var c=window.AudioContext||window.webkitAudioContext;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,o.prototype={constructor:o,init:function(t,e){t=t||{},this.lan=t.lan||"zh",this.workerPath=t.workerPath,this.audioContext=new c,this.converterWrapper=new i(t),e&&e()},start:function(){this.support&&navigator.getUserMedia({audio:!0},e.proxy(this._start,this),function(t){console.error(t)})},_start:function(t){var e=this.audioContext;this.audioInput=e.createMediaStreamSource(t),this.audioRecorder=new Recorder(this.audioInput,{workerPath:this.workerPath}),this.audioRecorder.clear(),this.audioRecorder.record()},stop:function(t){this.checkingStart()&&(this.audioRecorder.stop(),this.audioInput.disconnect(),t&&t())},pause:function(){this.checkingStart()&&this.audioRecorder.pause()},resume:function(){this.checkingStart()&&this.audioRecorder.record()},playSound:function(){this.audioRecorder.playSound()},stopSound:function(){this.audioRecorder.stopSound()},translate:function(t){if(this.checkingStart()){this.audioRecorder.exportWAV(this.handle.bind(this),{cb:t,type:"translate"})}},upload:function(t,e){if(t=t||{},this.checkingStart()){this.audioRecorder.exportWAV(this.handle.bind(this),{cb:e,type:"upload"})}},handle:function(t,e){"upload"===e.type?this.converterWrapper.upload(t,e,e.cb):this.converterWrapper.tranlate(t,{lan:self.lan},e.cb)},setDownloadUrl:function(t){this.audioRecorder.exportWAV(function(e){Recorder.setupDownload(e,"output",t)})},isRecording:function(){return this.audioRecorder&&this.audioRecorder.isRecording()},checkingStart:function(){return this.audioRecorder||console.error("you should call this function before call start method"),void 0!=this.audioRecorder},isSupport:function(){return this.support}},i.prototype={constructor:i,tranlate:function(t,e,o){this.server(this.url,t,e,o)},upload:function(t,e,o){this.server(this.uploadUrl,t,e,o)},server:function(t,o,i,r){var n=new FormData;n.append("file",new File([o],"ouput.wav"));for(var a in i)n.append(a,i[a]);return e.ajax({method:"POST",url:t,data:n,processData:!1,contentType:!1}).done(function(t){r&&r(t)})}},r.prototype={constructor:r,init:function(t,e){var o=t&&t.weixin?t.weixin:{};this.uploadUrl=t.uploadUrl,this.appId=o.appId,this.timestamp=o.timestamp,this.signature=o.signature,this.nonceStr=o.nonceStr,t.weixin&&wx.config({debug:o.debug||!1,appId:this.appId,timestamp:this.timestamp,nonceStr:this.nonceStr,signature:this.signature,jsApiList:["startRecord","stopRecord","onVoiceRecordEnd","translateVoice","playVoice","stopVoice","uploadVoice"]}),t.weixin&&wx.ready(function(t){e&&e(t)})},start:function(){this.recording=!0,wx.startRecord()},stop:function(t){this.recording=!1,self=this,wx.stopRecord({success:function(e){self.localId=e.localId,t(e.localId)}})},pause:function(){throw new Error("微信不支持这个方法")},resume:function(){throw new Error("微信不支持这个方法")},playSound:function(){return this.localId?void wx.playVoice({localId:this.localId}):void console.warn("you may no start recording voice")},stopSound:function(){return this.localId?void wx.stopVoice({localId:this.localId}):void console.warn("you may no start recording voice")},translate:function(t){wx.translateVoice({localId:this.localId,isShowProgressTips:1,success:function(e){var o,i,r;e.translateResult?(o=[e.translateResult],i=0):(i=3e3,r="未识别语音"),t({err_no:0,result:o,err_msg:r})}})},upload:function(t){var o=this;wx.uploadVoice({localId:this.localId,isShowProgressTips:1,success:function(i){e.ajax({method:"POST",url:o.uploadUrl,data:{server_id:i.serverId,weixin:!0}}).done(function(e){t&&t(e)})}})},isRecording:function(){return this.recording},checkingStart:function(){return this.recording},isSupport:function(){return!0}},n.prototype={constructor:n,init:function(t,e){var o=api.systemType;this.url=t.url,this.uploadUrl=t.uploadUrl,"ios"===o?this.ext="wav":"android"===o&&(this.ext="amr"),this.filePath="fs://test."+this.ext,this.audioRecorder=api.require("audioRecorder"),this.audio=api.require("audio"),e&&e()},start:function(){this.recording=!0;this.audioRecorder.startRecord({savePath:this.filePath,format:this.ext,channel:1},function(){})},stop:function(t){this.recording=!1,self=this,this.audioRecorder.stopRecord(function(e,o){t&&t()})},pause:function(){throw new Error("微信不支持这个方法")},resume:function(){throw new Error("微信不支持这个方法")},playSound:function(){this.audio.play({path:this.filePath},function(t,e){})},stopSound:function(){this.audio.stop()},translate:function(t){api.ajax({url:this.url,method:"post",data:{values:{ext:this.ext,sampleRate:16e3},files:{file:this.filePath}}},function(e,o){o&&alert("网络错误"),t&&t(e)})},upload:function(t,e){t=t||{},api.ajax({url:this.uploadUrl,method:"post",data:{values:t,files:{file:this.filePath}}},function(t,o){o&&alert("网络错误"),e&&e(t)})},isRecording:function(){return this.recording},checkingStart:function(){return this.recording},isSupport:function(){return!0}},a()?window.AudioTranslator=r:s()?window.AudioTranslator=n:window.AudioTranslator=o,e.isApiCloud=s,e.isWinxin=a}(window,jQuery),function(t){var e;t.audioTranslator=function(t){return e||(e=new AudioTranslator),e.init(t),e}}(jQuery),function(t){var e,o="./recorderWorker.js",i=function(t,i){var r=i||{},n=r.bufferLen||4096;this.context=t.context,this.context.createScriptProcessor?this.node=this.context.createScriptProcessor(n,2,2):this.node=this.context.createJavaScriptNode(n,2,2),console.log(i),e=e||new Worker(r.workerPath||o),e.postMessage({command:"init",config:{sampleRate:this.context.sampleRate,outputRate:8e3}});var a=!1,s={},c={};this.node.onaudioprocess=function(t){a&&e.postMessage({command:"record",buffer:[t.inputBuffer.getChannelData(0),t.inputBuffer.getChannelData(1)]})},this.configure=function(t){for(var e in t)t.hasOwnProperty(e)&&(r[e]=t[e])},this.record=function(){a=!0},this.isRecording=function(){return a},this.pause=function(){a=!1},this.stop=function(){this.pause(),this.node.disconnect(),t.disconnect()},this.clear=function(){e.postMessage({command:"clear"})},this.playSound=function(){var t=this;this.getBuffers(function(e){var o=t.context.createBuffer(2,e[0].length,t.context.sampleRate);t.source=t.context.createBufferSource(),o.copyToChannel(e[0],0,0),o.copyToChannel(e[1],1,0),t.source.buffer=o,t.source.connect(t.context.destination),t.source.start(0)})},this.stopSound=function(){this.source&&this.source.stop()},this.getBuffers=function(t){s.getBuffers=t||r.callback,e.postMessage({command:"getBuffers"})},this.exportWAV=function(t,o){if(s.exportWAV=t||r.callback,type=r.type||"audio/wav",o=o||{type:"default"},c[o.type]=o,!s)throw new Error("Callback not set");e.postMessage({command:"exportWAV",type:type,param:o.type})},this.exportWAVBase64=function(t,o){if(s.exportWAVBase64=t||r.callback,type=r.type||"audio/pcm",o=o||{type:"default"},c[o.type]=o,!s)throw new Error("Callback not set");e.postMessage({command:"exportWAVBase64",type:type,param:o.type})},e.onmessage=function(t){var e=t.data;switch(e.type){default:s[e.type]&&s[e.type](e.data,c[t.data.param])}},t.connect(this.node),this.node.connect(this.context.destination)};i.setupDownload=function(e,o,i){var r=(t.URL||t.webkitURL).createObjectURL(e),n=document.getElementById(i||"save");n.href=r,n.download=o||"output.wav"},t.Recorder=i}(window);